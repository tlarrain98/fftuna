{"ast":null,"code":"/*!\n * algorithms/hmac.js - HMAC-based \"signatures\"\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar CONSTANTS = require(\"./constants\"),\n    forge = require(\"../deps/forge.js\"),\n    DataBuffer = require(\"../util/databuffer.js\"),\n    helpers = require(\"./helpers.js\");\n\nfunction hmacSignFN(name) {\n  var md = name.replace(\"HS\", \"SHA\").toLowerCase(),\n      hash = name.replace(\"HS\", \"SHA-\");\n\n  function checkKeyLength(len, key) {\n    len = (len || CONSTANTS.HASHLENGTH[hash]) / 8;\n\n    if (len > key.length) {\n      return Promise.reject(new Error(\"invalid key length\"));\n    }\n\n    return Promise.resolve(key);\n  } // ### Fallback Implementation -- uses forge\n\n\n  var fallback = function (key, pdata, props) {\n    props = props || {};\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function () {\n      var sig = forge.hmac.create();\n      sig.start(md, key.toString(\"binary\"));\n      sig.update(pdata.toString(\"binary\"));\n      sig = Buffer.from(sig.digest().bytes(), \"binary\");\n      return {\n        data: pdata,\n        mac: sig\n      };\n    });\n    return promise;\n  }; // ### WebCryptoAPI Implementation\n\n\n  var webcrypto = function (key, pdata, props) {\n    props = props || {};\n    var alg = {\n      name: \"HMAC\",\n      hash: {\n        name: hash\n      }\n    };\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function () {\n      return helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"sign\"]);\n    });\n    promise = promise.then(function (key) {\n      return helpers.subtleCrypto.sign(alg, key, pdata);\n    });\n    promise = promise.then(function (result) {\n      var sig = Buffer.from(result);\n      return {\n        data: pdata,\n        mac: sig\n      };\n    });\n    return promise;\n  }; // ### NodeJS implementation\n\n\n  var nodejs = function (key, pdata, props) {\n    props = props || {};\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function () {\n      var hmac = helpers.nodeCrypto.createHmac(md, key);\n      hmac.update(pdata);\n      var sig = hmac.digest();\n      return {\n        data: pdata,\n        mac: sig\n      };\n    });\n    return promise;\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\nfunction hmacVerifyFN(name) {\n  var md = name.replace(\"HS\", \"SHA\").toLowerCase(),\n      hash = name.replace(\"HS\", \"SHA-\");\n\n  function compare(len, expected, actual) {\n    len = (len || CONSTANTS.HASHLENGTH[hash]) / 8;\n    var valid = true;\n\n    for (var idx = 0; len > idx; idx++) {\n      valid = valid && expected[idx] === actual[idx];\n    }\n\n    return valid;\n  } // ### Fallback Implementation -- uses forge\n\n\n  var fallback = function (key, pdata, mac, props) {\n    props = props || {};\n    var vrfy = forge.hmac.create();\n    vrfy.start(md, new DataBuffer(key));\n    vrfy.update(pdata.toString(\"binary\"));\n    vrfy = Buffer.from(vrfy.digest().bytes(), \"binary\");\n\n    if (compare(props.length, mac, vrfy)) {\n      return Promise.resolve({\n        data: pdata,\n        mac: mac,\n        valid: true\n      });\n    } else {\n      return Promise.reject(new Error(\"verification failed\"));\n    }\n  };\n\n  var webcrypto = function (key, pdata, mac, props) {\n    props = props || {};\n    var alg = {\n      name: \"HMAC\",\n      hash: {\n        name: hash\n      }\n    };\n    var promise;\n\n    if (props.length) {\n      promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"sign\"]);\n      promise = promise.then(function (key) {\n        return helpers.subtleCrypto.sign(alg, key, pdata);\n      });\n      promise = promise.then(function (result) {\n        var sig = Buffer.from(result);\n        return compare(props.length, mac, sig);\n      });\n    } else {\n      promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"verify\"]);\n      promise = promise.then(function (key) {\n        return helpers.subtleCrypto.verify(alg, key, mac, pdata);\n      });\n    }\n\n    promise = promise.then(function (result) {\n      if (!result) {\n        return Promise.reject(new Error(\"verifaction failed\"));\n      }\n\n      return {\n        data: pdata,\n        mac: mac,\n        valid: true\n      };\n    });\n    return promise;\n  };\n\n  var nodejs = function (key, pdata, mac, props) {\n    props = props || {};\n    var hmac = helpers.nodeCrypto.createHmac(md, key);\n    hmac.update(pdata);\n    var sig = hmac.digest();\n\n    if (!compare(props.length, mac, sig)) {\n      throw new Error(\"verification failed\");\n    }\n\n    return {\n      data: pdata,\n      mac: sig,\n      valid: true\n    };\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n} // ### Public API\n// * [name].sign\n// * [name].verify\n\n\nvar hmac = {};\n[\"HS1\", \"HS256\", \"HS384\", \"HS512\"].forEach(function (alg) {\n  hmac[alg] = {\n    sign: hmacSignFN(alg),\n    verify: hmacVerifyFN(alg)\n  };\n});\nmodule.exports = hmac;","map":{"version":3,"sources":["C:/Users/tlarr/ffwebsite/node_modules/node-jose/lib/algorithms/hmac.js"],"names":["CONSTANTS","require","forge","DataBuffer","helpers","hmacSignFN","name","md","replace","toLowerCase","hash","checkKeyLength","len","key","HASHLENGTH","length","Promise","reject","Error","resolve","fallback","pdata","props","promise","then","sig","hmac","create","start","toString","update","Buffer","from","digest","bytes","data","mac","webcrypto","alg","subtleCrypto","importKey","sign","result","nodejs","nodeCrypto","createHmac","setupFallback","hmacVerifyFN","compare","expected","actual","valid","idx","vrfy","verify","forEach","module","exports"],"mappings":"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","sourcesContent":["/*!\n * algorithms/hmac.js - HMAC-based \"signatures\"\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar CONSTANTS = require(\"./constants\"),\n    forge = require(\"../deps/forge.js\"),\n    DataBuffer = require(\"../util/databuffer.js\"),\n    helpers = require(\"./helpers.js\");\n\nfunction hmacSignFN(name) {\n  var md = name.replace(\"HS\", \"SHA\").toLowerCase(),\n      hash = name.replace(\"HS\", \"SHA-\");\n\n  function checkKeyLength(len, key) {\n    len = (len || CONSTANTS.HASHLENGTH[hash]) / 8;\n    if (len > key.length) {\n      return Promise.reject(new Error(\"invalid key length\"));\n    }\n\n    return Promise.resolve(key);\n  }\n\n  // ### Fallback Implementation -- uses forge\n  var fallback = function(key, pdata, props) {\n    props = props || {};\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function() {\n      var sig = forge.hmac.create();\n      sig.start(md, key.toString(\"binary\"));\n      sig.update(pdata.toString(\"binary\"));\n      sig = Buffer.from(sig.digest().bytes(), \"binary\");\n\n      return {\n        data: pdata,\n        mac: sig\n      }\n    });\n    return promise;\n  };\n\n  // ### WebCryptoAPI Implementation\n  var webcrypto = function(key, pdata, props) {\n    props = props || {};\n\n    var alg = {\n      name: \"HMAC\",\n      hash: {\n        name: hash\n      }\n    };\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function() {\n      return helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"sign\"]);\n    });\n    promise = promise.then(function(key) {\n      return helpers.subtleCrypto.sign(alg, key, pdata);\n    });\n    promise = promise.then(function(result) {\n      var sig = Buffer.from(result);\n      return {\n        data: pdata,\n        mac: sig\n      };\n    });\n\n    return promise;\n  };\n\n  // ### NodeJS implementation\n  var nodejs = function(key, pdata, props) {\n    props = props || {};\n\n    var promise;\n    promise = checkKeyLength(props.length, key);\n    promise = promise.then(function() {\n      var hmac = helpers.nodeCrypto.createHmac(md, key);\n      hmac.update(pdata);\n\n      var sig = hmac.digest();\n      return {\n        data: pdata,\n        mac: sig\n      };\n    });\n    return promise;\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\nfunction hmacVerifyFN(name) {\n  var md = name.replace(\"HS\", \"SHA\").toLowerCase(),\n      hash = name.replace(\"HS\", \"SHA-\");\n\n  function compare(len, expected, actual) {\n    len = (len || CONSTANTS.HASHLENGTH[hash]) / 8;\n    var valid = true;\n    for (var idx = 0; len > idx; idx++) {\n      valid = valid && (expected[idx] === actual[idx]);\n    }\n    return valid;\n  }\n\n  // ### Fallback Implementation -- uses forge\n  var fallback = function(key, pdata, mac, props) {\n    props = props || {};\n\n    var vrfy = forge.hmac.create();\n    vrfy.start(md, new DataBuffer(key));\n    vrfy.update(pdata.toString(\"binary\"));\n    vrfy = Buffer.from(vrfy.digest().bytes(), \"binary\");\n\n    if (compare(props.length, mac, vrfy)) {\n      return Promise.resolve({\n        data: pdata,\n        mac: mac,\n        valid: true\n      });\n    } else {\n      return Promise.reject(new Error(\"verification failed\"));\n    }\n  };\n\n  var webcrypto = function(key, pdata, mac, props) {\n    props = props || {};\n\n    var alg = {\n      name: \"HMAC\",\n      hash: {\n        name: hash\n      }\n    };\n    var promise;\n    if (props.length) {\n      promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"sign\"]);\n      promise = promise.then(function(key) {\n        return helpers.subtleCrypto.sign(alg, key, pdata);\n      });\n      promise = promise.then(function(result) {\n        var sig = Buffer.from(result);\n        return compare(props.length, mac, sig);\n      });\n    } else {\n      promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"verify\"]);\n      promise = promise.then(function(key) {\n        return helpers.subtleCrypto.verify(alg, key, mac, pdata);\n      });\n    }\n    promise = promise.then(function(result) {\n      if (!result) {\n        return Promise.reject(new Error(\"verifaction failed\"));\n      }\n\n      return {\n        data: pdata,\n        mac: mac,\n        valid: true\n      };\n    });\n\n    return promise;\n  };\n\n  var nodejs = function(key, pdata, mac, props) {\n    props = props || {};\n\n    var hmac = helpers.nodeCrypto.createHmac(md, key);\n    hmac.update(pdata);\n\n    var sig = hmac.digest();\n    if (!compare(props.length, mac, sig)) {\n      throw new Error(\"verification failed\");\n    }\n    return {\n      data: pdata,\n      mac: sig,\n      valid: true\n    };\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\n// ### Public API\n// * [name].sign\n// * [name].verify\nvar hmac = {};\n[\n  \"HS1\",\n  \"HS256\",\n  \"HS384\",\n  \"HS512\"\n].forEach(function(alg) {\n  hmac[alg] = {\n    sign: hmacSignFN(alg),\n    verify: hmacVerifyFN(alg)\n  };\n});\n\nmodule.exports = hmac;\n"]},"metadata":{},"sourceType":"script"}